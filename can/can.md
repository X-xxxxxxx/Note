# [Can总线通信](https://zhuanlan.zhihu.com/p/677658199)

## 历史

 <!-- ![图片](https://picx.zhimg.com/70/v2-95d5ac87546b078e4ac6d18ae7da9ab9_1440w.avis?source=172ae18b&biz_tag=Post, "car") -->
 * 随着设备功能越来越多，电子装置之间的通讯越来越复杂，于是设计了一个单一的网络总线，所有外围器件挂接在该总线上。
 * can是一种多主方式的串行通讯总线

 * 优点主要有
    * 有高的位速率
    * 高抗电磁干扰性
    * 而且能够检测出产生的任何错误
    * 高实时性
    * 高性能，可靠性
## 总线结构

分为**开环**和**闭环**两种形式
* 闭环结构：总线两端各连接一个**120欧**的电阻，两根信号线形成回路。这种CAN总线网络由ISO 11898标准定义，是高速、短距离的CAN网络，通信速率为125kbit/s到1Mbit/s。在1Mbit/s通讯速率时，总线长度最长达40m
* 开环结构：开环结构的CAN总线网络，两根信号线独立，各自串联一个2.2k欧的电阻。这种CAN总线网络由ISO11519-2标准定义，是低速、远距离的CAN网络，通信速率最高125kbit/s。在40kbit/s速率时，总线最长距离可达1000m

can是一种**异步通信**方式，而**SPI**和**IIC**是和时钟信号同步的同步通信方式

使用双绞线传输**差分信号**(抗干扰能力强)，同样使用差分信号传输的还有**RS485**网络

逻辑0对应显性电平， 逻辑1对应隐性电平

CAN总线上的一个终端设备称为一个节点（Node）
一个CAN节点的硬件部分一般由**CAN控制器**和**CAN收发器**两个部分组成。  

CAN控制器负责CAN总线的逻辑控制，实现CAN传输协议；

CAN收发器主要负责MCU逻辑电平与CAN总线电平之间的转换

## CAN总线优先级以及同步

在总线空闲态，最先开始发送消息的单元获得发送权

多个单元同时开始发送时，各发送单元从仲裁段的第一位开始进行仲裁。**连续输出显性电平最多的单元**可继续发送

* 数据帧和摇控帧优先级决定
    * 具有相同 ID 的数据帧和遥控帧在总线上竞争时，仲裁段的最后一位（RTR）为显性位的数据帧具有优先权，可继续发送。
* 标准格式和扩展格式的优先级
    * 标准格式 ID 与具有相同 ID 的遥控帧或者扩展格式的数据帧在总线上竞争时，标准格式的 RTR 位为显性位的具有优先权，可继续发送

## 位时序
由发送单元在非同步的情况下发送的每秒钟的位数称为位速率

可分为4段
* 同步段（SS）
* 传播时间段（PTS）
* 相位缓冲段 1（PBS1）
* 相位缓冲段 2（PBS2）

## 取得同步

CAN 协议的通信方法为 NRZ（Non-Return to Zero）方式。  


各个位的开头或者结尾都没有附加同步信号。  


发送单元以与位时序同步的方式开始发送数据。  

接收单元根据总线上电平的变化进行同步并进行接收工作。


传输路径上的**相位延迟**会引起发送端和接收端的**同步偏差**


接收单元通过[硬件同步](#硬件同步)或者[再同步](#再同步)的方法调整时序进行接收

## 硬件同步

接收单元在总线空闲状态检测出帧起始时进行的同步调整。在检测出边沿的地方不考虑 SJW 的值而认为是 SS 段
## 再同步

在接收过程中检测出总线上的电平变化时进行的同步调整。 每当检测出边沿时，根据 SJW 值通过加长 PBS1 段，或缩短 PBS2 段，以调整同步。但如果发生了超出 SJW 值的误差时，最大调整量不能超过 SJW 值